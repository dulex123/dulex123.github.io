<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Docked deep learning &#8211; Dusan Josipovic</title>
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
    <link rel="dns-prefetch" href="//cdn.mathjax.org">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Avoid bloating your system with tons of dependencies.">
    <meta name="robots" content="all">
    <meta name="author" content="Душан Јосиповић">
    
    <meta name="keywords" content="posts">
    <link rel="canonical" href="http://dulex123.github.io/posts/2017/02/09/docked-deep-learning/">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Dusan Josipovic" href="/feed.xml" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css?201702101747" type="text/css">

    <!-- Fonts -->
    
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
    

    <!-- MathJax -->
    

    <!-- Verifications -->
    
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Docked deep learning">
    <meta property="og:description" content="Experimental software engineering.">
    <meta property="og:url" content="http://dulex123.github.io/posts/2017/02/09/docked-deep-learning/">
    <meta property="og:site_name" content="Dusan Josipovic">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
    <meta name="twitter:title" content="Docked deep learning" />
    <meta name="twitter:description" content="Avoid bloating your system with tons of dependencies." />
    <meta name="twitter:url" content="http://dulex123.github.io/posts/2017/02/09/docked-deep-learning/" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">

    
</head>

<body class="site">
  
	

  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://dulex123.github.io" class="site-title">Dusan Josipovic</a>
      <nav class="site-nav">
        
    
    
    

    
        <a href="/about/">About</a>
    
    
    

    
    
        <a href="/contact/">Contact</a>
    
    

    
    
    

    
    
    

    
    
    

    
    
    

    
    
    

<a href="/feed.xml">RSS</a>

      </nav>
      <div class="clearfix"></div>
      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Docked deep learning</h1>
  <span class="post-meta">Feb 9, 2017</span> / <span>posts</span><br>
  
  <span class="post-meta small">
  
    7 minute read
  
  </span>
</div>

<article class="post-content">
  <p><em>If you are tired of installing bloatware everytime you want to run a project that has dependencies, then Docker may be a solution for you!</em></p>

<hr />

<p>Docker allows you to isolate your new project environment from your host OS efficiently, something like virtualenv in python but more VM-like, but then again without the whole OS installation and massive resource consumption.</p>

<h2 id="theory">1. Theory</h2>

<p>So let’s start with easy docker concepts:</p>

<ul>
  <li>
    <p><strong>Container</strong><br />
All action happens within the container. When you want to run a script you run it from the inside of a container, if you want to install software, you run it inside the container. If your friend wants to try your software without wasting 14hrs on framework stack setup, you send him your container.</p>

    <p>So the container is an environment in which you can do whatever you want with no consequences to your host OS. And if you screw something up within a container? You just delete it, create another one (or 6, 10, 200) just like it and try again.</p>

    <p>So container idea as a separate entity should be clear by now. But what is within a container? What software is preinstalled? Which OS?</p>
  </li>
</ul>

<p>These questions lead us to <em>the image</em>.</p>

<ul>
  <li><strong>Image</strong>
Image is an immutable template that can be instantiated as a container. Something like this:</li>
</ul>

<p><img src="http://i.imgur.com/xZr1QfY.png" alt="Image container relationship" /></p>

<p>So once created, an image is immutable (changes during the lifetime of a container does not affect the image). It serves as a common ground for all containers it instantiates. Whatever you do is saved within a container, but container communicates with its image and all operations are going through the image. You need one image, and you can instantiate any number of containers.</p>

<p>How this helps is evident from the following:</p>

<p><em>If you had a 2GB VM, you would need 2GB x how many VMs you want. And that’s only disk space; there will be massive consumption of CPU, RAM and other resources you need. With Docker, much of that 2GB are shared between containers, and with 1000 containers you will get only a little over a 2GB space requirement. (If they are of the same image ofc) So for less isolation than an actual VM you are getting very lightweight containers.</em></p>

<p>Also, fully virtualized VM takes minutes to start where Docker container takes only seconds.</p>

<p>An alternative explanation of image and container relationship from OOP perception:<br />
  - Image is equivalent to a class in OOP whereas<br />
  - A container is equivalent to an object</p>

<p>But what defines an image? How is it created? - It comes from a  txt file called:</p>

<ul>
  <li>
    <p><strong>Dockerfile</strong>
Textual file on what to setup within an image that can later be instantiated as a container and used. You build docker image from dockerfile.</p>

    <p>The beautiful thing is that probably someone somewhere before you needed the same or similar stack and there are docker files for you just to download them. Even better, instead of building an image yourself (which depending on a dockerfile can last for quite some time), you can find them online at dockerhub or similar websites, download it, instantiate a container and start experimenting with your code.</p>
  </li>
</ul>

<p>Although containers are isolated, you can share folders between host OS and container, open network ports, etc., just as in regular VM.</p>

<h2 id="practice">2. Practice</h2>
<p>So let’s use all this information to create a suitable environment for a deep learning project. My host OS is Ubuntu 16.04 so that’s what I’ll use.</p>

<ul>
  <li>Step 0: Install docker and nvidia-docker
    <ul>
      <li><a href="https://docs.docker.com/engine/installation/linux/ubuntu/">Official docker installation</a></li>
      <li><a href="https://github.com/NVIDIA/nvidia-docker">Nvidia-docker</a> package is used to leverage GPU for anything you do inside container, you just need to have nvidia drivers installed on your host OS. It is not necessary, but for our application is very desirable. If you are not using GPU you don’t need this package. Everywhere you see nvidia-docker just type docker instead.</li>
    </ul>
  </li>
  <li>Step 1: Getting suitable dockerfile
    <ul>
      <li>
        <p>I’ve stumbled upon this great dockerfile repo <a href="https://github.com/floydhub/dl-docker">dl-docker</a>. It will install Ubuntu 14.04 with CUDA 8, cuDNNv5, Tensorflow, Caffe, Theano, Keras, Lasagne, Torch, iPython/Jupyter, Numpy-Scipy-Scikit learn-matplotlib on top of it.</p>

        <p>To get the dockerfile from github just type:</p>
      </li>
    </ul>

    <div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>git clone https://github.com/saiprashanths/dl-docker.git
<span class="gp">$ </span><span class="nb">cd </span>dl-docker
</code></pre>
    </div>
  </li>
  <li>Step 2: Build or download image
    <ul>
      <li>Since many images are available for download, you can directly download your image from a place like <a href="https://hub.docker.com/">dockerhub</a>. We are going to build our own image because currently there is no GPU image for dockerfile on dockerhub. Check the bottom of this page if you run into errors:</li>
    </ul>

    <div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># Notice the dot at the end</span>
<span class="gp">$ </span>docker build -t floydhub/dl-docker:gpu -f Dockerfile.gpu .
</code></pre>
    </div>

    <p><em>There is an image on dockerhub without GPU support and we could download it without building</em></p>

    <div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># We don't need this if we are using GPU</span>
<span class="gp">$ </span>docker pull floydhub/dl-docker:cpu
</code></pre>
    </div>
  </li>
  <li>Step 3: Instantiate a container
    <ul>
      <li>Now we will create our container with two network ports and one folder shared with the host OS.</li>
    </ul>

    <div class="highlighter-rouge"><pre class="highlight"><code>nvidia-docker run -it -p 8888:8888 -p 6006:6006 -v /sharedfolder:/root/sharedfolder floydhub/dl-docker:gpu bash
</code></pre>
    </div>

    <p>Parameter <strong>-p port1:port2</strong> maps port1 from host OS to port2 on container<br />
This means that whatever is launched on port2 inside container will show up in your host OS browser if you go to http://localhost:port1.</p>

    <p>Parameter <strong>-v folder1:folder2</strong> maps absolute path folder1 on host OS to folder2 on container. If you change anything in folder1 it will reflect inside of a container on folder2.</p>
  </li>
</ul>

<p>Once you create a container, you will get a root access to it (no need for users since it is isolated right?). When you finish your work, you can type exit, and it will save the container state and stop the container. You will probably want to use that container again so here are some commands that can be helpful:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># List all images</span>
<span class="gp">$ </span>sudo docker images

<span class="c"># List currently running containers</span>
<span class="gp">$ </span>sudo docker ps

<span class="c"># List all containers</span>
<span class="gp">$ </span>sudo docker ps -a

<span class="c"># Start some container</span>
<span class="gp">$ </span>sudo docker start &lt;container_name&gt;

<span class="c"># Connect to container (Attach to container terminal)</span>
<span class="gp">$ </span>sudo docker attach &lt;container_name&gt;

<span class="c"># Connect second terminal to container (or more)</span>
<span class="gp">$ </span>sudo docker <span class="nb">exec</span> -it &lt;container_name&gt; bash

<span class="c"># Remove a container</span>
<span class="gp">$ </span>sudo docker rm &lt;container_name&gt;

<span class="c"># Remove an image</span>
<span class="gp">$ </span>sudo docker rmi &lt;image_name&gt;

<span class="c"># You can use container_id instead of container_name</span>

</code></pre>
</div>

<p><strong>Note:</strong> I’ve said that you can ship containers to a friend. Although this is possible much more sensible thing to do would be for him to download/build an image and pull your project from a git repo, within the instantiated container.</p>

<p>You may also find useful this <a href="https://github.com/wsargent/docker-cheat-sheet/blob/master/README.md">beautiful cheatsheet</a> that has many
useful docker commands which can help your docker-fu.</p>

<h2 id="errors-while-building-the-image">Errors while building the image:</h2>

<ul>
  <li>
    <p>setup.py egg_info error can be solved with</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>pip install <span class="nv">setuptools</span><span class="o">==</span>33.1.1
</code></pre>
    </div>
  </li>
  <li>
    <p>If you get an error with libopenjpeg2, the package is renamed to libopenjpeg5 so you just need to:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>sudo apt-get install libopenjpeg5
</code></pre>
    </div>
  </li>
</ul>


</article>











      </div>
    </div>
  </div>

    <div class="measure">
      <!-- Made with &lt;3 for AI -->
  </div>
  <div style="min-height:100px;">

  </div>
</footer>


</body>
</html>
